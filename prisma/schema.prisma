generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["views"]
}

datasource db {
  provider = "postgresql"
}

enum BookingStatus {
  PENDING
  CONFIRMED
  REJECTED
  CANCELLED_BY_CUSTOMER
}

enum NotificationType {
  BOOKING_REQUEST
  BOOKING_UPDATE
  SYSTEM
  PARTNER_REQUEST
  PARTNER_UPDATE
}

enum SubscriptionTier {
  FREE
  STANDARD
  PREMIUM
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum Status {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model User {
  id                          String    @id @default(cuid())
  email                       String    @unique
  password                    String
  name                        String?
  phone                       String?
  city                        String?
  profile_picture             String?
  registration_date           DateTime  @default(now())
  role                        String    @default("customer")
  account_type                String?
  company_name                String?
  inn                         String?
  description                 String?
  background_picture          String?
  roles                       String[]
  price_range                 Int[]
  latitude                    Float?
  longitude                   Float?
  subscription_plan_id        String?   @default("econom")
  subscription_end_date       DateTime?
  moderation_status           String    @default("pending_approval")
  sub_profile_ids             String[]
  created_at                  DateTime  @default(now())
  updated_at                  DateTime  @updatedAt
  profile_picture_alt_text    String?
  background_picture_alt_text String?
  profile_meta_title          String?
  profile_meta_description    String?
  profile_keywords            String?
  details                     Json?
  status                      String?   @default("active")
  emailVerified               DateTime?
  experience                  String?
  resetPasswordToken          String?
  resetPasswordExpires        DateTime?
  favorite_performers         Json?

  // --- NEW: 1-to-1 Relation with Partner Profile ---
  partner_profile Partner?

  reviews_written       Review[]      @relation("CustomerReviews")
  reviews_received      Review[]      @relation("PerformerReviews")
  bookings_as_customer  Booking[]     @relation("CustomerBookings")
  bookings_as_performer Booking[]     @relation("PerformerBookings")
  paid_requests         PaidRequest[]
  gallery_items         GalleryItem[]

  support_requests_as_requester SupportRequest[] @relation("RequesterSupport")
  support_requests_as_manager   SupportRequest[] @relation("ManagerSupport")

  // Notice: partner referral events removed, only keeping the referred user relation
  referral_events_as_referred ReferralEvent[] @relation("ReferredUser")

  favorites_given        Favorite[]             @relation("CustomerFavorites")
  favorites_received     Favorite[]             @relation("PerformerFavorites")
  certificates           Certificate[]
  recommendation_letters RecommendationLetter[]
  prompts                Prompt[]
  chats                  Chat[]                 @relation("ChatParticipants")
  messages               Message[]
  notifications          Notification[]
  subscription           UserSubscription?
  payments               Payment[]
  accounts               Account[]
  sessions               Session[]
  verificationTokens     VerificationToken[]

  parentAgencyId String?
  parentAgency   User?   @relation("AgencySpecialists", fields: [parentAgencyId], references: [id])
  subProfiles    User[]  @relation("AgencySpecialists")
}

// --- NEW PARTNER MODEL ---
model Partner {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  referralId           String  @unique
  balance              Float   @default(0)
  totalEarned          Float   @default(0)
  totalRegistrations   Int     @default(0)
  totalPaidConversions Int     @default(0)
  clicks               Int     @default(0)
  minPayout            Float   @default(1500)
  paymentDetails       String? @db.Text

  referralEvents ReferralEvent[]
  payoutRequests PayoutRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("partners")
}

model Review {
  id            String   @id @default(cuid())
  performer_id  String
  customer_id   String
  customer_name String
  rating        Int
  comment       String?
  created_at    DateTime @default(now())

  performer User @relation("PerformerReviews", fields: [performer_id], references: [id])
  customer  User @relation("CustomerReviews", fields: [customer_id], references: [id])
}

model Booking {
  id      String        @id @default(uuid())
  date    DateTime
  details String?
  status  BookingStatus @default(PENDING)

  customerId String
  customer   User   @relation("CustomerBookings", fields: [customerId], references: [id])

  performerId String
  performer   User   @relation("PerformerBookings", fields: [performerId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Payment   Payment[]
}

model PartnershipRequest {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  website   String
  status    Status   @default(PENDING)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("partnership_requests")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id])
  type      NotificationType
  message   String
  data      Json?
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
}

model PaidRequest {
  id         String @id @default(uuid())
  customerId String
  customer   User   @relation(fields: [customerId], references: [id])

  category           String
  serviceDescription String
  city               String?
  budget             String?

  status String @default("PENDING_PAYMENT")

  paymentId String?  @unique
  payment   Payment? @relation(fields: [paymentId], references: [id])

  views     Int @default(0)
  responses Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GalleryItem {
  id                String   @id @default(cuid())
  performer_id      String
  title             String
  description       String?
  image_urls        String[]
  moderation_status String   @default("pending_approval")
  meta_title        String?
  meta_description  String?
  keywords          String?
  image_alt_text    String?
  created_at        DateTime @default(now())

  performer User @relation(fields: [performer_id], references: [id])
}

model Chat {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants    User[]          @relation("ChatParticipants")
  messages        Message[]
  support_request SupportRequest?
}

model Message {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  isRead    Boolean  @default(false)

  chatId String
  chat   Chat   @relation(fields: [chatId], references: [id], onDelete: Cascade)

  senderId String
  sender   User   @relation(fields: [senderId], references: [id], onDelete: Cascade)
}

model SupportRequest {
  id                  String    @id @default(cuid())
  requester_id        String
  requester_name      String
  chat_id             String    @unique
  status              String    @default("open")
  assigned_manager_id String?
  created_at          DateTime  @default(now())
  closed_at           DateTime?

  requester        User  @relation("RequesterSupport", fields: [requester_id], references: [id])
  chat             Chat  @relation(fields: [chat_id], references: [id])
  assigned_manager User? @relation("ManagerSupport", fields: [assigned_manager_id], references: [id])
}

model ReferralEvent {
  id                String   @id @default(cuid())
  partner_id        String
  referred_user_id  String
  commission_amount Float?
  event_type        String
  status            String?  @default("pending")
  created_at        DateTime @default(now())

  // FIXED: Partner ID now correctly points to Partner model
  partner       Partner @relation(fields: [partner_id], references: [id], onDelete: Cascade)
  referred_user User    @relation("ReferredUser", fields: [referred_user_id], references: [id], onDelete: Cascade)

  @@map("referral_events")
}

model PayoutRequest {
  id              String   @id @default(cuid())
  partner_id      String
  amount          Float
  status          String   @default("pending")
  payment_details String?  @db.Text
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // FIXED: Partner ID now correctly points to Partner model
  partner Partner @relation(fields: [partner_id], references: [id], onDelete: Cascade)

  @@map("payout_requests")
}

model Favorite {
  id           String   @id @default(cuid())
  customer_id  String
  performer_id String
  created_at   DateTime @default(now())

  customer  User @relation("CustomerFavorites", fields: [customer_id], references: [id])
  performer User @relation("PerformerFavorites", fields: [performer_id], references: [id])

  @@unique([customer_id, performer_id])
}

model Article {
  id               String   @id @default(uuid())
  title            String
  content          String   @db.Text
  slug             String   @unique
  media_url        String?
  media_type       String?
  meta_title       String?
  image_alt_text   String?
  meta_description String?
  keywords         String?
  isActive         Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model SiteSettings {
  id          String  @id @default("general_settings")
  siteName    String  @default("Eventomir")
  logoUrl     String?
  logoAltText String?
  faviconUrl  String?
  fontFamily  String  @default("Inter, sans-serif")
  contacts    Json?   @default("{}")
  theme       Json?   @default("{\"backgroundColor\": \"#ffffff\", \"primaryColor\": \"#3b82f6\", \"accentColor\": \"#f59e0b\"}")

  siteCategories  Json @default("[]")
  pageSpecificSEO Json @default("[]")

  updatedAt DateTime @updatedAt

  @@map("site_settings")
}

model PricingConfig {
  id          String   @id @default("pricing_config")
  config_data Json?
  updated_at  DateTime @updatedAt
}

model Certificate {
  id                String   @id @default(cuid())
  performer_id      String
  file_url          String
  description       String?
  moderation_status String   @default("pending_approval")
  created_at        DateTime @default(now())

  performer User @relation(fields: [performer_id], references: [id])
}

model RecommendationLetter {
  id                String   @id @default(cuid())
  performer_id      String
  file_url          String
  description       String?
  moderation_status String   @default("pending_approval")
  created_at        DateTime @default(now())

  performer User @relation(fields: [performer_id], references: [id])
}

model Prompt {
  id        String   @id @default(cuid())
  userId    String
  prompt    String
  response  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model SubscriptionPlan {
  id              String           @id @default(uuid())
  name            String
  description     String
  tier            SubscriptionTier @unique
  priceMonthly    Int              @default(0)
  priceHalfYearly Int?             @default(0)
  priceYearly     Int?             @default(0)

  features  String[]
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions UserSubscription[]
}

model UserSubscription {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  planId String
  plan   SubscriptionPlan @relation(fields: [planId], references: [id])

  startDate DateTime  @default(now())
  endDate   DateTime?
  isActive  Boolean   @default(true)
  autoRenew Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id           String        @id @default(uuid())
  userId       String
  user         User          @relation(fields: [userId], references: [id])
  amount       Int
  currency     String        @default("RUB")
  status       PaymentStatus @default(PENDING)
  provider     String
  providerTxId String?
  metadata     Json?

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  booking     Booking?     @relation(fields: [bookingId], references: [id])
  bookingId   String?
  paidRequest PaidRequest?
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  expires      DateTime
  sessionToken String   @unique
  accessToken  String   @unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id         String    @id @default(cuid())
  identifier String?
  userId     String?
  token      String    @unique
  expires    DateTime?
  user       User?     @relation(fields: [userId], references: [id])

  @@unique([identifier, token])
}
